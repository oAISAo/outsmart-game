<ion-header [translucent]="true" class="intro-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button fill="clear" color="light" (click)="onClose()" aria-label="Back to missions">
        <ion-icon slot="icon-only" name="chevron-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button fill="clear" color="light" (click)="onInfo()" aria-label="Game tips">
        <ion-icon slot="icon-only" name="help-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="intro-content">

  @if (scenario(); as current) {

    <section class="intro-hero">
      <div class="hero-overlay"></div>
      <div class="hero-inner">
        <h1 #introHeading tabindex="-1">{{ current.title }}</h1>

        <!-- Lobby Code Display -->
        @if (game(); as g) {
          <div class="lobby-code-container">
            <p class="lobby-label">GAME CODE</p>
            <div class="code-display" (click)="copyCode()">
              <span>{{ g.code }}</span>
              <ion-icon name="copy-outline"></ion-icon>
            </div>
            <p class="lobby-hint">Share this code with your friends to join.</p>
          </div>
        }

        <div class="hero-summary">
          @for (paragraph of current.longDescription; track $index) {
            <p>{{ paragraph }}</p>
          }
        </div>

        <div class="intro-meta">
          <span class="meta-chip">{{ current.defaultDurationMinutes }} min</span>
          <span class="meta-chip">{{ current.numberOfPlayers }} players</span>
        </div>

        <!-- Host Button (Only if not in game) -->
        @if (!game()) {
          <div class="action-container">
            <ion-button expand="block" color="primary" (click)="onHostGame()" [disabled]="isLoading()">
              <span *ngIf="!isLoading()">Host Game</span>
              <ion-spinner *ngIf="isLoading()"></ion-spinner>
            </ion-button>
          </div>
        }
      </div>
    </section>

    <section class="intro-body">
      <article class="intro-section">
        <h2>Choose Your Character</h2>
        <p class="section-subtitle">Each character has unique abilities that will help solve the mystery.</p>

        <div class="role-cards-grid">
          @for (role of current.roles; track role.id) {
            <div class="role-card"
                 [attr.data-role]="role.id"
                 [class.role-card--taken]="isRoleTaken(role.id)"
                 [class.role-card--selected]="myRole() === role.id">

              <div class="role-card__header">
                <span class="role-card__emoji">{{ role.emoji }}</span>
                <div class="role-card__title-block">
                  <h3 class="role-card__name">{{ role.name }}</h3>
                  <span class="role-card__badge">{{ role.shortDescription }}</span>
                </div>
                <!-- Player Badge if taken -->
                @if (getPlayerNameForRole(role.id); as playerName) {
                  <div class="player-badge">
                    <ion-icon name="person-outline"></ion-icon>
                    <span>{{ playerName }}</span>
                  </div>
                }
              </div>

              <div class="role-card__body">
                <p class="role-card__description">{{ role.description }}</p>

                <div class="role-card__inventory">
                  <span class="inventory-label">Starting Item</span>
                  @for (item of role.startingInventory; track item.name) {
                    <div class="inventory-item">
                      <strong class="item-name">{{ item.name }}</strong>
                      <span class="item-description">{{ item.description }}</span>
                    </div>
                  }
                </div>
              </div>

              <div class="role-card__footer">
                @if (game()) {
                  <ion-button
                    expand="block"
                    class="role-select-button"
                    [color]="myRole() === role.id ? 'success' : 'primary'"
                    [disabled]="isRoleTaken(role.id)"
                    (click)="onSelectRole(role.id)">
                    {{ myRole() === role.id ? 'Selected' : (isRoleTaken(role.id) ? 'Taken' : 'Select ' + role.name) }}
                  </ion-button>
                } @else {
                  <div class="role-preview-text">Host a game to select this role</div>
                }
              </div>
            </div>
          }
        </div>
      </article>
    </section>

  } @else {
    <section class="intro-empty">
      <p>Unable to load this scenario. Feel free to return to the mission list.</p>
    </section>
  }
</ion-content>

@if (tipsOpen()) {
  <ion-modal
    [isOpen]="true"
    (didDismiss)="closeTips()"
    [backdropDismiss]="true"
    class="tips-modal modal-margin-stretch">
    <ng-template>
      <ion-header class="tips-modal__header">
        <ion-toolbar>
          <ion-title class="modal-text-color">Game Tips</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" color="light" (click)="closeTips()" aria-label="Close tips">
              <ion-icon slot="icon-only" name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="tips-modal__content">
        <div class="tips-content-wrapper">
          <ul class="tips-list modal-text-color">
            @for (tip of tips; track $index) {
              <li>{{ tip }}</li>
            }
          </ul>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
}

<ion-footer class="intro-footer">
  <ion-toolbar>
    @if (game()) {
      <div class="intro-footer__cta">
        @if (isHost()) {
          <ion-button expand="block" class="start-button" (click)="onStart()" [disabled]="isLoading()">
            <span *ngIf="!isLoading()">Start Game</span>
            <ion-spinner *ngIf="isLoading()"></ion-spinner>
          </ion-button>
        } @else {
          <p class="intro-footer__waiting">Waiting for the host to start the game...</p>
        }
      </div>
    }
  </ion-toolbar>
</ion-footer>
